<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scrape Energy Data</title>
    <script>
        function selectAll() {
            var items = document.getElementsByName('postcodes');
            for (var i = 0; i < items.length; i++) {
                if (items[i].type == 'checkbox')
                    items[i].checked = true;
            }
        }

        function deselectAll() {
            var items = document.getElementsByName('postcodes');
            for (var i = 0; i < items.length; i++) {
                if (items[i].type == 'checkbox')
                    items[i].checked = false;
            }
        }
    </script>
</head>
<body>
    <h1>Energy Data Scraper</h1>
    <form method="POST">
        <div>
            <h2>Select Postcodes:</h2>
            {% for code in postcodes %}
            <label>
                <input type="checkbox" name="postcodes" value="{{ code }}" checked>{{ code }}
            </label><br>
            {% endfor %}
            <button type="button" onclick="selectAll()">Select All</button>
            <button type="button" onclick="deselectAll()">Deselect All</button>
        </div>
        <button type="submit" name="action" value="Scrape Data">Scrape Data</button>
        <button type="submit" name="action" value="Clear Data">Clear Data</button>
    </form>
    <h1>Postcode Data Scraper</h1>
    <button onclick="startScraping()">Scrape All Postcodes</button>
    <div id="status"></div>


    <h2>Scraped Data</h2>
    <div>{{ data_table|safe }}</div>
    <a href="{{ url_for('download_csv_singlular') }}">Download CSV</a>

    <script>
        let postcodes = {{ postcodes | tojson }};
        let current = 0;

        function startScraping() {
            if (current < postcodes.length) {
                scrapePostcode(postcodes[current]);
            } else {
                document.getElementById('status').innerHTML += '<p>All postcodes processed.</p>';
            }
        }

        function scrapePostcode(postcode) {
            document.getElementById('status').innerHTML += `<p>Processing ${postcode}...</p>`;
            fetch('/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({postcode: postcode})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('status').innerHTML += `<p>${data.message}</p>`;
                if (data.filepath) {
                    document.getElementById('status').innerHTML += `<a href="/download/${data.filepath.split('/').pop()}">Download ${postcode} data</a><br>`;
                }
                current++;
                startScraping();  // Trigger the next postcode
            })
            .catch(error => {
                document.getElementById('status').innerHTML += `<p>Error processing ${postcode}: ${error}</p>`;
                current++;
                startScraping();
            });
        }

    </script>
</body>
</html>
